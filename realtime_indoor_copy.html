<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>real time indoor</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
</head>

<body style="margin: 0px; overflow: hidden;">
	<a-scene
	vr-mode-ui="enabled: false"
	embedded
	arjs="sourceType: webcam; debugUIEnabled: false;"
	>
	<!--1.一樓大門: gps-entity-place="latitude: 22.9986416; longitude: 120.2199345;" position="0 26.728 0"-->
	<a-text
		value="gate"
		scale="1 1 1"
	></a-text>
	<a-entity
		rotation="0 0 0"
		scale="1 1 1"
		gltf-model="./assets/pin.gltf"
	></a-entity>
	<!--2.經緯廳: gps-entity-place="latitude: 22.9987154; longitude: 120.2200520;" position="0 27.033 0"-->
	<a-text
		value="Chin-Way Hall"
		scale="1 1 1"
	></a-text>
	<a-entity
		rotation="0 0 0"
		scale="1 1 1"
		gltf-model="./assets/pin.gltf"
	></a-entity>
	<!--3.大一教室: gps-entity-place="latitude: 22.9987299; longitude: 120.2200649;" position="0 31.634 0"-->
	<a-text
		value="55250"
		scale="1 1 1"
		color="yellow"
	></a-text>
	<a-entity
		rotation="0 0 0"
		scale="1 1 1"
		gltf-model="./assets/pin_yellow.gltf"
	></a-entity>
	<!--4.電腦教室: gps-entity-place="latitude: 22.9987492; longitude: 120.2200666;" position="0 31.634 0"-->
	<a-text
		value="55208"
		scale="1 1 1"
		color="yellow"
	></a-text>
	<a-entity
		rotation="0 0 0"
		scale="1 1 1"
		gltf-model="./assets/pin_yellow.gltf"
	></a-entity>
	<!--5.圖書室: gps-entity-place="latitude: 22.9987189; longitude: 120.2202121;" position="0 31.634 0"-->
	<a-text
		value="55209"
		scale="1 1 1"
		color="yellow"
	></a-text>
	<a-entity
		rotation="0 0 0"
		scale="1 1 1"
		gltf-model="./assets/pin_yellow.gltf"
	></a-entity>
	<!--6.55210實驗室: gps-entity-place="latitude: 22.9987382; longitude: 120.2202138;" position="0 31.634 0"-->
	<a-text
		value="55210"
		scale="1 1 1"
		color="yellow"
	></a-text>
	<a-entity
		rotation="0 0 0"
		scale="1 1 1"
		gltf-model="./assets/pin_yellow.gltf"
	></a-entity>
	<!--7.55316實驗室: gps-entity-place="latitude: 22.9987492; longitude: 120.2200666;" position="0 36.148 0"-->
	<a-text
		value="Our lab"
		scale="1 1 1"
		color="red"
	></a-text>
	<a-entity
		rotation="0 0 0"
		scale="1 1 1"
		gltf-model="./assets/pin_red.gltf"
	></a-entity>
		
	<a-camera rotation-reader></a-camera>
	</a-scene>
	
	<script>
		//set a-entity data (e,n,h: a實體設定座標)
    var data_e = [120.2199345, 120.2200520, 120.2200649, 120.2200666, 120.2202121, 120.2202138, 120.2200666];
    var data_n = [22.9986416, 22.9987154, 22.9987299, 22.9987492, 22.9987189, 22.9987382, 22.9987492];
    var data_h = [26.728, 27.033, 31.634, 31.634, 31.634, 31.634, 36.148];
    
    //get azimuth
    var theta = 0;
		var theta_rad = 0;
		window.addEventListener('deviceorientation', function(event) {
			theta = -(event.webkitCompassHeading-180-90);
			theta_rad = theta * Math.PI /180;
		});
		
		//watch position for outdoor
		/*var watchID = navigator.geolocation.watchPosition(function(position) {
			SetLocation("text",position);SetLocation("entity",position);
		});*/
		
		//watch position for indoor (呼叫後端API，從GIPS server獲取定位軌跡)
		const MyApiURL = "https://901b-140-116-47-130.ngrok.io/gipsense/TrackAPI.php"; //80 port: ngrok http 80
		var position = '';
		jQuery(document).ready(function(){
			setInterval(function() {
				$.getJSON( MyApiURL, function( data ) {
					console.log("x: "+ data.x +"y: "+ data.y +"z: "+ data.z);
					position = {coords:{latitude: data.y, longitude: data.x, altitude: data.z + 26.728}};
					//position.coords.altitude = data.z + 26.728;
					//position.coords.latitude = data.y;
					//position.coords.longitude = data.x;
					SetLocation("text",position);SetLocation("entity",position);
				});
			}, 1000);
		});
		
		//設定各模型相對於所在即時位置的高及位置
		function SetLocation(type,position){ //type: a實體類型, position: 用戶即時位置座標
      var target = document.querySelectorAll('a-'+type);
      for(var j=0; j<target.length; j++){
        if (type=="text"){
          target[j].setAttribute("look-at", {x: 0, y: 0, z: 0});
          data_h[j] += 2.4;
        } 
        var H = data_h[j] - position.coords.altitude;
        var N = (data_n[j] - position.coords.latitude)*110751.075273;
        var E = (data_e[j] - position.coords.longitude)*101751.561277; //各方向距離差(公尺)
        var z = Math.cos(theta_rad)*E + Math.sin(theta_rad)*N;
        var x = Math.cos(theta_rad)*N - Math.sin(theta_rad)*E; //換算至手機相機坐標系中(公尺)

        var target_att = document.createAttribute('position');
        target_att.value = x+" "+H+" "+z;
        target[j].setAttributeNode(target_att);
      }
		};
		
	</script>
</body>
</html>
